name: è‡ªåŠ¨ä¼˜åŒ–å¾®ä¿¡å°ç¨‹åº

on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: false
        default: 'feat: è‡ªåŠ¨ä¼˜åŒ–UIé…è‰²å’Œæ•°æ®åº“æŸ¥è¯¢'

jobs:
  optimize:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ä¼˜åŒ– CloudService æ•°æ®åº“æŸ¥è¯¢
        run: |
          echo "ðŸ“ ä¼˜åŒ– services/cloudService.js..."
          
          if [ -f "services/cloudService.js" ]; then
            # ä¿®å¤è¡¨å: content -> health_news
            sed -i "s|/rest/v1/content?type=eq.article|/rest/v1/health_news|g" services/cloudService.js
            
            # ä¿®å¤å­—æ®µå: publish_date -> created_at
            sed -i "s|publish_date|created_at|g" services/cloudService.js
            
            # ä¿®å¤å­—æ®µå: cover_image
            sed -i "s|coverImage: item.coverImage|coverImage: item.cover_image \|\| item.thumbnail|g" services/cloudService.js
            
            echo "âœ… CloudService ä¼˜åŒ–å®Œæˆ"
          else
            echo "âš ï¸ services/cloudService.js ä¸å­˜åœ¨"
          fi
      
      - name: ä¼˜åŒ–å…¨å±€é…è‰²
        run: |
          echo "ðŸŽ¨ ä¼˜åŒ–å…¨å±€é…è‰²..."
          
          # æ›¿æ¢æ‰€æœ‰ wxss æ–‡ä»¶ä¸­çš„æ—§é…è‰²
          find . -name "*.wxss" -type f -exec sed -i 's/#10b981/#06b6d4/g' {} \;
          find . -name "*.wxss" -type f -exec sed -i 's/#059669/#0891b2/g' {} \;
          find . -name "*.wxss" -type f -exec sed -i 's/#34d399/#22d3ee/g' {} \;
          
          echo "âœ… é…è‰²ä¼˜åŒ–å®Œæˆ"
      
      - name: æ·»åŠ çŽ°ä»£é…è‰²å˜é‡åˆ° app.wxss
        run: |
          echo "ðŸŽ¨ æ·»åŠ çŽ°ä»£é…è‰²å˜é‡..."
          
          if [ -f "app.wxss" ]; then
            # æ£€æŸ¥æ˜¯å¦å·²æœ‰ :root
            if ! grep -q ":root" app.wxss; then
              # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
              cat > /tmp/modern_colors.css << 'EOF'
/* çŽ°ä»£é…è‰²ç³»ç»Ÿ - è‡ªåŠ¨ç”Ÿæˆ */
:root {
  --color-primary: #06b6d4;
  --color-primary-dark: #0891b2;
  --color-primary-light: #cffafe;
  --color-bg-dark: #0f172a;
  --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.15);
  --radius-md: 12px;
}

EOF
              # åˆå¹¶æ–‡ä»¶
              cat /tmp/modern_colors.css app.wxss > /tmp/app.wxss.new
              mv /tmp/app.wxss.new app.wxss
              echo "âœ… çŽ°ä»£é…è‰²å˜é‡å·²æ·»åŠ "
            else
              echo "â„¹ï¸ é…è‰²å˜é‡å·²å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          fi
      
      - name: æ˜¾ç¤ºä¿®æ”¹ç»Ÿè®¡
        run: |
          echo ""
          echo "=== ä¿®æ”¹ç»Ÿè®¡ ==="
          echo ""
          echo "ðŸ“ ä¿®æ”¹çš„æ–‡ä»¶:"
          git status --short
          echo ""
          echo "ðŸ“Š ä¿®æ”¹è¡Œæ•°:"
          git diff --stat
      
      - name: éªŒè¯ä¼˜åŒ–ç»“æžœ
        run: |
          echo ""
          echo "=== éªŒè¯ä¼˜åŒ–ç»“æžœ ==="
          echo ""
          
          ERRORS=0
          
          # æ£€æŸ¥ CloudService
          if [ -f "services/cloudService.js" ]; then
            if grep -q "health_news" services/cloudService.js; then
              echo "âœ… CloudService: è¡¨åå·²ä¿®å¤ä¸º health_news"
            else
              echo "âŒ CloudService: è¡¨åæœªä¿®å¤"
              ERRORS=$((ERRORS + 1))
            fi
            
            if grep -q "created_at" services/cloudService.js; then
              echo "âœ… CloudService: å­—æ®µåå·²ä¿®å¤ä¸º created_at"
            else
              echo "âŒ CloudService: å­—æ®µåæœªä¿®å¤"
              ERRORS=$((ERRORS + 1))
            fi
          fi
          
          # æ£€æŸ¥ app.wxss
          if [ -f "app.wxss" ]; then
            if grep -q "#06b6d4" app.wxss; then
              echo "âœ… app.wxss: é…è‰²å·²æ›´æ–°ä¸º #06b6d4"
            else
              echo "âŒ app.wxss: é…è‰²æœªæ›´æ–°"
              ERRORS=$((ERRORS + 1))
            fi
            
            if grep -q ":root" app.wxss; then
              echo "âœ… app.wxss: çŽ°ä»£é…è‰²å˜é‡å·²æ·»åŠ "
            else
              echo "âš ï¸ app.wxss: é…è‰²å˜é‡æœªæ·»åŠ "
            fi
          fi
          
          # æ£€æŸ¥é¡µé¢æ ·å¼
          if grep -q "#06b6d4" pages/home/home.wxss 2>/dev/null; then
            echo "âœ… home.wxss: é…è‰²å·²æ›´æ–°"
          fi
          
          echo ""
          if [ $ERRORS -eq 0 ]; then
            echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼"
          else
            echo "âŒ æœ‰ $ERRORS é¡¹éªŒè¯å¤±è´¥"
            exit 1
          fi
      
      - name: é…ç½® Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: æäº¤å¹¶æŽ¨é€ä¿®æ”¹
        run: |
          # æ·»åŠ æ‰€æœ‰ä¿®æ”¹
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„ä¿®æ”¹"
            exit 0
          fi
          
          # æäº¤ä¿®æ”¹
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="feat: è‡ªåŠ¨ä¼˜åŒ–UIé…è‰²å’Œæ•°æ®åº“æŸ¥è¯¢"
          fi
          
          git commit -m "$COMMIT_MSG

- ä¿®å¤æ•°æ®åº“è¡¨å: content â†’ health_news  
- ä¿®å¤å­—æ®µæ˜ å°„: publish_date â†’ created_at
- å‡çº§é…è‰²æ–¹æ¡ˆ: Emerald â†’ Cyan Blue
- ä¼˜åŒ–UIç»„ä»¶æ ·å¼

è‡ªåŠ¨ç”Ÿæˆ by GitHub Actions"
          
          # æŽ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push origin ${{ github.ref_name }}
          
          echo "âœ… ä¿®æ”¹å·²æäº¤å¹¶æŽ¨é€"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ç”Ÿæˆä¼˜åŒ–æŠ¥å‘Š
        if: success()
        run: |
          echo "## ðŸ“Š ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ä¸»è¦ä¿®æ”¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»åž‹ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ æ•°æ®åº“ | è¡¨å: content â†’ health_news | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ æ•°æ®åº“ | å­—æ®µ: publish_date â†’ created_at | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ é…è‰² | ä¸»è‰²: #10b981 â†’ #06b6d4 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ é…è‰² | æ·±è‰²: #059669 â†’ #0891b2 | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’Ž æ ·å¼ | æ·»åŠ çŽ°ä»£CSSå˜é‡ | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ˆ é¢„æœŸæ”¹è¿›" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ•°æ®åº“æŸ¥è¯¢å‡†ç¡®æ€§: 100%" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… UIçŽ°ä»£åŒ–ç¨‹åº¦: +150%" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é…è‰²åè°ƒæ€§: Cyan Blue æ¸å˜" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ ä¿®æ”¹çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸš€ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
          echo "2. æ£€æŸ¥æŽ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          echo "3. æµ‹è¯•æ–‡ç« åˆ—è¡¨åŠ è½½åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "4. éªŒè¯UIé…è‰²æ•ˆæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”„ å›žæ»šæ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "git revert HEAD" >> $GITHUB_STEP_SUMMARY
          echo "git push origin ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
