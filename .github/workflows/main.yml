name: è‡ªåŠ¨ä¼˜åŒ–å¾®ä¿¡å°ç¨‹åº

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: false
        default: 'feat: è‡ªåŠ¨ä¼˜åŒ–UIé…è‰²å’Œæ•°æ®åº“æŸ¥è¯¢'

jobs:
  optimize:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: æ‰§è¡Œä¼˜åŒ–è„šæœ¬
        run: |
          # è¿è¡Œä¼˜åŒ–è„šæœ¬
          python optimize_miniapp.py --base-path .
          
          # æ˜¾ç¤ºä¿®æ”¹çš„æ–‡ä»¶
          echo "=== ä¿®æ”¹çš„æ–‡ä»¶ ==="
          git status --short
      
      - name: éªŒè¯ä¼˜åŒ–ç»“æžœ
        run: |
          echo "=== æ£€æŸ¥å…³é”®æ–‡ä»¶ ==="
          
          # æ£€æŸ¥ services/cloudService.js
          if grep -q "health_news" services/cloudService.js; then
            echo "âœ… CloudService: è¡¨åå·²ä¿®å¤"
          else
            echo "âŒ CloudService: è¡¨åæœªä¿®å¤"
            exit 1
          fi
          
          # æ£€æŸ¥ app.wxss
          if grep -q "#06b6d4" app.wxss; then
            echo "âœ… app.wxss: é…è‰²å·²æ›´æ–°"
          else
            echo "âŒ app.wxss: é…è‰²æœªæ›´æ–°"
            exit 1
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼"
      
      - name: é…ç½® Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: æäº¤å¹¶æŽ¨é€ä¿®æ”¹
        run: |
          # æ·»åŠ æ‰€æœ‰ä¿®æ”¹
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„ä¿®æ”¹"
            exit 0
          fi
          
          # æäº¤ä¿®æ”¹
          git commit -m "${{ github.event.inputs.commit_message }}"
          
          # æŽ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ç”Ÿæˆä¼˜åŒ–æŠ¥å‘Š
        if: success()
        run: |
          echo "## ðŸ“Š ä¼˜åŒ–å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ä¸»è¦ä¿®æ”¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ ä¿®å¤æ•°æ®åº“è¡¨å: content â†’ health_news" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ å‡çº§é…è‰²æ–¹æ¡ˆ: Emerald â†’ Cyan Blue" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ ç§»é™¤å†—ä½™Mockæ•°æ®æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’Ž ä¼˜åŒ–UIç»„ä»¶æ ·å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ é¢„æœŸæ”¹è¿›" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è¡Œæ•°å‡å°‘çº¦30%" >> $GITHUB_STEP_SUMMARY
          echo "- æ•°æ®åº“æŸ¥è¯¢æ›´å‡†ç¡®" >> $GITHUB_STEP_SUMMARY
          echo "- UIæ›´åŠ çŽ°ä»£åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºä¼˜åŒ–æŠ¥å‘Š
          if [ -f "OPTIMIZATION_REPORT.json" ]; then
            echo "### ðŸ“„ è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat OPTIMIZATION_REPORT.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
