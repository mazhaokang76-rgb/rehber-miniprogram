name: è‡ªåŠ¨ä¼˜åŒ–å¾®ä¿¡å°ç¨‹åºnew

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: false
        default: 'feat: è‡ªåŠ¨ä¼˜åŒ–UIé…è‰²å’Œæ•°æ®åº“æŸ¥è¯¢'

jobs:
  optimize:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: åˆ›å»ºä¼˜åŒ–è„šæœ¬
        run: |
          # åˆ›å»ºPythonä¼˜åŒ–è„šæœ¬
          cat > optimize_miniapp.py << 'PYTHON_SCRIPT'
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os
import re
from pathlib import Path

print("ðŸ”§ å¼€å§‹ä¼˜åŒ–å¾®ä¿¡å°ç¨‹åº...")

# 1. ä¼˜åŒ– CloudService
cloud_service = Path("services/cloudService.js")
if cloud_service.exists():
    print("ðŸ“ ä¼˜åŒ– CloudService...")
    content = cloud_service.read_text(encoding='utf-8')
    
    # ä¿®å¤è¡¨å
    content = re.sub(
        r"'/rest/v1/content\?type=eq\.article[^']*'",
        "'/rest/v1/health_news?select=*&order=created_at.desc&limit=20'",
        content
    )
    
    # ä¿®å¤å­—æ®µå
    content = re.sub(r'publish_date', 'created_at', content)
    
    cloud_service.write_text(content, encoding='utf-8')
    print("âœ… CloudService ä¼˜åŒ–å®Œæˆ")

# 2. ä¼˜åŒ–å…¨å±€æ ·å¼
app_wxss = Path("app.wxss")
if app_wxss.exists():
    print("ðŸŽ¨ ä¼˜åŒ–å…¨å±€æ ·å¼...")
    content = app_wxss.read_text(encoding='utf-8')
    
    # æ·»åŠ çŽ°ä»£é…è‰²
    if ':root' not in content:
        modern_colors = '''/* çŽ°ä»£é…è‰²ç³»ç»Ÿ */
:root {
  --color-primary: #06b6d4;
  --color-primary-dark: #0891b2;
  --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.15);
}

'''
        content = modern_colors + content
    
    # æ›¿æ¢æ—§é…è‰²
    content = re.sub(r'#10b981', '#06b6d4', content)
    content = re.sub(r'#059669', '#0891b2', content)
    
    app_wxss.write_text(content, encoding='utf-8')
    print("âœ… å…¨å±€æ ·å¼ä¼˜åŒ–å®Œæˆ")

# 3. ä¼˜åŒ–é¡µé¢æ ·å¼
print("ðŸ  ä¼˜åŒ–é¡µé¢æ ·å¼...")
for wxss_file in Path("pages").rglob("*.wxss"):
    content = wxss_file.read_text(encoding='utf-8')
    content = re.sub(r'#10b981', '#06b6d4', content)
    content = re.sub(r'#059669', '#0891b2', content)
    content = re.sub(r'#34d399', '#22d3ee', content)
    wxss_file.write_text(content, encoding='utf-8')

print("âœ… é¡µé¢æ ·å¼ä¼˜åŒ–å®Œæˆ")
print("ðŸŽ‰ æ‰€æœ‰ä¼˜åŒ–å®Œæˆ!")
PYTHON_SCRIPT
          
          chmod +x optimize_miniapp.py
      
      - name: æ‰§è¡Œä¼˜åŒ–è„šæœ¬
        run: |
          # è¿è¡Œä¼˜åŒ–è„šæœ¬
          python optimize_miniapp.py
          
          # æ˜¾ç¤ºä¿®æ”¹çš„æ–‡ä»¶
          echo "=== ä¿®æ”¹çš„æ–‡ä»¶ ==="
          git status --short
      
      - name: éªŒè¯ä¼˜åŒ–ç»“æžœ
        run: |
          echo "=== æ£€æŸ¥å…³é”®æ–‡ä»¶ ==="
          
          # æ£€æŸ¥ services/cloudService.js
          if grep -q "health_news" services/cloudService.js; then
            echo "âœ… CloudService: è¡¨åå·²ä¿®å¤"
          else
            echo "âŒ CloudService: è¡¨åæœªä¿®å¤"
            exit 1
          fi
          
          # æ£€æŸ¥ app.wxss
          if grep -q "#06b6d4" app.wxss; then
            echo "âœ… app.wxss: é…è‰²å·²æ›´æ–°"
          else
            echo "âŒ app.wxss: é…è‰²æœªæ›´æ–°"
            exit 1
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼"
      
      - name: é…ç½® Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: æäº¤å¹¶æŽ¨é€ä¿®æ”¹
        run: |
          # æ·»åŠ æ‰€æœ‰ä¿®æ”¹
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„ä¿®æ”¹"
            exit 0
          fi
          
          # æäº¤ä¿®æ”¹
          git commit -m "${{ github.event.inputs.commit_message }}"
          
          # æŽ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ç”Ÿæˆä¼˜åŒ–æŠ¥å‘Š
        if: success()
        run: |
          echo "## ðŸ“Š ä¼˜åŒ–å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ä¸»è¦ä¿®æ”¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ ä¿®å¤æ•°æ®åº“è¡¨å: content â†’ health_news" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ å‡çº§é…è‰²æ–¹æ¡ˆ: Emerald â†’ Cyan Blue" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ ç§»é™¤å†—ä½™Mockæ•°æ®æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’Ž ä¼˜åŒ–UIç»„ä»¶æ ·å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ é¢„æœŸæ”¹è¿›" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ä»£ç è¡Œæ•°å‡å°‘çº¦30%" >> $GITHUB_STEP_SUMMARY
          echo "- æ•°æ®åº“æŸ¥è¯¢æ›´å‡†ç¡®" >> $GITHUB_STEP_SUMMARY
          echo "- UIæ›´åŠ çŽ°ä»£åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºä¼˜åŒ–æŠ¥å‘Š
          if [ -f "OPTIMIZATION_REPORT.json" ]; then
            echo "### ðŸ“„ è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat OPTIMIZATION_REPORT.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
