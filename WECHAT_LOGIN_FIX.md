# 微信登录授权失败修复指南

## 🚨 问题原因

微信小程序的 `wx.getUserProfile` API 从2022年开始已经停止使用，导致授权失败。

## ✅ 已完成修复

### 1. 更新 app.json 配置
- 添加了用户信息权限声明
- 配置了权限描述信息

### 2. 更新登录逻辑 (login.js)
- 移除已废弃的 `wx.getUserProfile()` 调用
- 改用 `wx.login()` 获取微信登录凭证
- 简化登录流程，提高成功率
- 增强错误处理，支持用户已存在的情况

## 🔧 开发者工具设置检查

请确保在微信开发者工具中进行以下设置：

### 1. 基础设置
- 确保使用最新版本的微信开发者工具
- 项目设置 > 本地设置 > 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书（开发阶段）

### 2. 调试设置
- 打开调试模式：详情 > 项目配置 > 启用调试
- 清除缓存：工具 > 清除缓存 > 清除全部缓存
- 重新编译项目

### 3. 模拟器设置
- 使用 iPhone 6/7/8 模拟器进行测试
- 确保网络连接正常

## 📱 测试步骤

1. **重新编译项目**
   ```
   工具栏 > 编译 或者 Ctrl+B
   ```

2. **清除缓存**
   ```
   工具栏 > 清除缓存 > 清除全部缓存
   ```

3. **测试登录流程**
   - 点击"微信一键登录"按钮
   - 应该立即显示"登录成功！"提示
   - 自动跳转到首页
   - 检查TabBar是否正常显示

## 🔍 常见问题排查

### 问题1: 仍然显示"授权失败"
**解决方案：**
- 清除微信开发者工具缓存
- 重新启动开发者工具
- 确保网络连接正常

### 问题2: 登录成功但不跳转
**解决方案：**
- 检查 TabBar 配置是否正确
- 手动点击首页标签
- 查看控制台是否有跳转错误

### 问题3: 首页显示空白
**解决方案：**
- 检查首页数据加载逻辑
- 确认 Supabase 连接正常
- 查看网络请求是否成功

## 📊 新登录流程说明

### 原流程（已废弃）
```
点击按钮 → wx.getUserProfile() → 获取用户信息 → wx.login() → 登录
```

### 新流程（当前使用）
```
点击按钮 → wx.login() → 生成用户标识 → 直接登录 → 跳转首页
```

## 🎯 预期结果

- ✅ 点击登录按钮无需弹出授权框
- ✅ 直接显示"登录成功！"提示
- ✅ 1.5秒后自动跳转到首页
- ✅ 首页正常加载训练视频和健康资讯
- ✅ 底部TabBar正常工作

## 🚀 下一步测试

请按照以下顺序测试：

1. **重新编译项目**
2. **清除缓存**
3. **点击微信一键登录**
4. **确认跳转到首页**
5. **测试TabBar切换**
6. **检查首页内容加载**

如果还有问题，请提供具体的错误信息或截图。